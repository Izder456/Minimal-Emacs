<p>After trying <a rel="noopener" target="_blank" href="https://www.cambus.net/netbsd-on-the-vortex86dx-cpu/">NetBSD</a> and <a rel="noopener" target="_blank" href="https://www.cambus.net/openbsd-on-the-vortex86dx-cpu/">OpenBSD</a> on my DMP EBOX 3300A-H with a
<strong>Vortex86DX</strong> CPU, I was curious to see how FreeBSD would fare on such
constrained systems these days.</p>
<p>For more information and background about the hardware, please refer to my
<a rel="noopener" target="_blank" href="https://www.cambus.net/netbsd-on-the-vortex86dx-cpu/">previous</a> article.</p>
<p>Attempting to install <strong>FreeBSD 13.0</strong> failed early when loading the kernel,
and both supported releases from the FreeBSD 12 series (12.2 and 12.3) also
exhibit the same issue.</p>
<pre style="background-color:#272822;color:#f8f8f2;"><code><span>int=00000006  err=00000000  efl=00000002  eip=013d1651
</span><span>eax=01fe26b0  ebx=0008274c  ecx=00000000  edx=01fe8b77
</span><span>esi=01d8c3d8  edi=019b20c8  ebp=019b2038  esp=00000000
</span><span>cs=0008  ds=0010  es=0010    fs=0010  gs=0010  ss=0010
</span><span>cs:eip=0f 45 f0 a1 88 20 9b 01-85 c0 0f 45 f0 81 c6 ff
</span><span>       ff 3f 00 81 e6 00 00 c0-ff 89 35 d4 ad d8 01 8d
</span><span>ss:esp=f3 ee 00 f0 f3 ee 00 f0-c3 e2 00 f0 f3 ee 00 f0
</span><span>       f3 ee 00 f0 54 ff 00 f0-4f 07 00 f0 f7 06 00 f0
</span><span>BTX halted
</span></code></pre>
<p>FreeBSD 13.0 <a rel="noopener" target="_blank" href="https://www.freebsd.org/releases/13.0R/relnotes/">release notes</a> mention that the default CPUTYPE for the i386
architecture is now 686 (instead of 486), and have details on the rationale
behind this change.</p>
<p>After digging a bit, it turns out some Vortex86 CPUs lack support for the
<strong>Conditional Move</strong> (<strong>CMOV</strong>) instruction, and code targeting i686 will
fail on those models.</p>
<p>Using <strong>objdump</strong> to disassemble the kernels for the 12.2, 12.3, and 13.0
releases revealed that they were indeed using CMOV. Performing
the same checks on the kernels from FreeBSD 12.0 and 12.1 releases did not
show any CMOV instructions use.</p>
<p>The FreeBSD 12.1 installation process completed successfully and I could
reboot into the installed system without issues. This version is not
supported anymore but it doesn't matter in this case as it's more of a
one-off thing for the purpose of writing this post, the machine being
too constrained for any real world usage in this day and age.</p>
<p>For installing <strong>pkg</strong> and binary packages, I had to modify the url
directive in <em>/etc/pkg/FreeBSD.conf</em> to:</p>
<pre style="background-color:#272822;color:#f8f8f2;"><code><span>url: &quot;pkg+http://pkg.FreeBSD.org/${ABI}/release_2&quot;,
</span></code></pre>
<p>Indeed, <em>quarterly</em> packages and <em>release_3</em> packages are apparently
targeting i686 and their binaries contain CMOV instructions.</p>
<p>Attempting to run i686 binaries result in the following error:</p>
<pre style="background-color:#272822;color:#f8f8f2;"><code><span>Illegal instruction (core dumped)
</span></code></pre>
<p>We can verify that the culprits are indeed CMOV instructions with the
following program:</p>
<pre data-lang="asm" style="background-color:#272822;color:#f8f8f2;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#a6e22e;">.</span><span style="color:#66d9ef;">section </span><span style="color:#a6e22e;">.text
</span><span>
</span><span style="color:#a6e22e;">.globl _start
</span><span>
</span><span style="color:#a6e22e;">_start:
</span><span style="color:#a6e22e;">	</span><span style="color:#f92672;">cmovl	</span><span style="color:#a6e22e;">%</span><span style="font-style:italic;color:#fd971f;">eax</span><span>, </span><span style="color:#a6e22e;">%</span><span style="font-style:italic;color:#fd971f;">ebx
</span></code></pre>
<p>Let's assemble, link, and run it:</p>
<pre style="background-color:#272822;color:#f8f8f2;"><code><span>as cmov.s -o cmov.o
</span><span>ld cmov.o -o cmov
</span><span>./cmov
</span><span>Illegal instruction (core dumped)
</span></code></pre>
<p>With this out of the way, we now have a fully functioning FreeBSD 12.1
installation on this machine.</p>
<p>On a freshly booted system, 16 processes are running and most of the RAM is
unused.</p>
<pre data-lang="sh" style="background-color:#272822;color:#f8f8f2;" class="language-sh "><code class="language-sh" data-lang="sh"><span>last pid:   787</span><span style="color:#f92672;">;  </span><span>load averages:  0.30,  0.30,  0.13  up 0+00:02:12    09:55:29
</span><span>16 processes:  1 running, 15 sleeping
</span><span>CPU:  6.2% user,  0.0% nice, 10.1% system,  2.1% interrupt, 81.6% idle
</span><span>Mem: 6556K Active, 1028K Inact, 28M Wired, 16M Buf, 181M Free
</span><span>Swap: 2752M Total, 2752M Free
</span><span>
</span><span>  PID USERNAME    THR PRI NICE   SIZE    RES STATE    TIME    WCPU COMMAND
</span><span>  751 root          1  22    0  5268K  2616K wait     0:00   0.00% login
</span><span>  759 root          1  20    0  6192K  3108K pause    0:00   0.00% csh
</span><span>  581 root          1  20    0  4588K  2112K select   0:00   0.00% syslogd
</span><span>  692 root          1  20    0  8772K  5360K select   0:00   0.00% sendmail
</span><span>  699 root          1  24    0  4588K  2104K nanslp   0:00   0.00% cron
</span><span>  787 root          1  23    0  5868K  2592K RUN      0:00   0.00% top
</span><span>  752 root          1  52    0  4276K  1908K ttyin    0:00   0.00% getty
</span><span>  756 root          1  52    0  4276K  1908K ttyin    0:00   0.00% getty
</span><span>  758 root          1  52    0  4276K  1908K ttyin    0:00   0.00% getty
</span><span>  753 root          1  52    0  4276K  1908K ttyin    0:00   0.00% getty
</span><span>  757 root          1  52    0  4276K  1908K ttyin    0:00   0.00% getty
</span><span>  754 root          1  52    0  4276K  1908K ttyin    0:00   0.00% getty
</span><span>  755 root          1  52    0  4276K  1908K ttyin    0:00   0.00% getty
</span><span>  695 smmsp         1  52    0  8548K  4848K pause    0:00   0.00% sendmail
</span><span>   94 root          1  52    0  4152K  1688K pause    0:00   0.00% adjkerntz
</span><span>  421 root          1  20    0  3864K  1108K select   0:00   0.00% devd
</span></code></pre>
<p>Here is the result of the <strong>md5 -t</strong> benchmark:</p>
<pre data-lang="sh" style="background-color:#272822;color:#f8f8f2;" class="language-sh "><code class="language-sh" data-lang="sh"><span>MD5 time trial. Digesting 100000 10000-byte blocks ... done
</span><span>Digest = 766a2bb5d24bddae466c572bcabca3ee
</span><span>Time = 20.719989 seconds
</span><span>Speed = 46.026777 MiB/second
</span></code></pre>
<p>And this is the result of the <strong>sha1 -t</strong> benchmark:</p>
<pre data-lang="sh" style="background-color:#272822;color:#f8f8f2;" class="language-sh "><code class="language-sh" data-lang="sh"><span>SHA1 time trial. Digesting 100000 10000-byte blocks ... done
</span><span>Digest = 02522491d7a8253fcab708560acfa84b2fb7ef1c
</span><span>Time = 54.165445 seconds
</span><span>Speed = 17.606692 MiB/second
</span></code></pre>
<p>For the record, OpenSSL speed benchmark results are available
<a href="/files/freebsd/openssl-speed-vortex86.txt">here</a>.</p>
<p>Finally, here is a dmesg for reference purposes:</p>
<pre style="background-color:#272822;color:#f8f8f2;"><code><span>Copyright (c) 1992-2019 The FreeBSD Project.
</span><span>Copyright (c) 1979, 1980, 1983, 1986, 1988, 1989, 1991, 1992, 1993, 1994
</span><span>	The Regents of the University of California. All rights reserved.
</span><span>FreeBSD is a registered trademark of The FreeBSD Foundation.
</span><span>FreeBSD 12.1-RELEASE r354233 GENERIC i386
</span><span>FreeBSD clang version 8.0.1 (tags/RELEASE_801/final 366581) (based on LLVM 8.0.1)
</span><span>VT(vga): resolution 640x480
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>CPU: PentiumUnknown (1000.02-MHz 586-class CPU)
</span><span>  Origin=&quot;Vortex86 SoC&quot;  Id=0x522
</span><span>real memory  = 268435456 (256 MB)
</span><span>avail memory = 225300480 (214 MB)
</span><span>random: unblocking device.
</span><span>stray irq7
</span><span>Timecounter &quot;TSC&quot; frequency 1000023008 Hz quality 800
</span><span>random: entropy device external interface
</span><span>kbd1 at kbdmux0
</span><span>[ath_hal] loaded
</span><span>module_register_init: MOD_LOAD (vesa, 0x14d9fb0, 0) error 19
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>ACPI: Table initialisation failed: AE_NOT_FOUND
</span><span>ACPI: Try disabling either ACPI or apic support.
</span><span>vtvga0: &lt;VT VGA driver&gt; on motherboard
</span><span>cryptosoft0: &lt;software crypto&gt; on motherboard
</span><span>pcib0 pcibus 0 on motherboard
</span><span>pir0: &lt;PCI Interrupt Routing Table: 12 Entries&gt; on motherboard
</span><span>pci0: &lt;PCI bus&gt; on pcib0
</span><span>vgapci0: &lt;VGA-compatible display&gt; port 0xdf80-0xdfff mem 0xf8000000-0xfbffffff,0xfefc0000-0xfeffffff at device 3.0 on pci0
</span><span>vgapci0: Boot video device
</span><span>isab0: &lt;PCI-ISA bridge&gt; at device 7.0 on pci0
</span><span>isa0: &lt;ISA bus&gt; on isab0
</span><span>vte0: &lt;RDC R6040 FastEthernet&gt; port 0xde00-0xdeff mem 0xfefbb400-0xfefbb4ff irq 10 at device 8.0 on pci0
</span><span>miibus0: &lt;MII bus&gt; on vte0
</span><span>rdcphy0: &lt;R6040 10/100 media interface&gt; PHY 1 on miibus0
</span><span>rdcphy0:  none, 10baseT, 10baseT-FDX, 100baseTX, 100baseTX-FDX, auto
</span><span>vte0: Ethernet address: 00:1b:eb:22:16:5c
</span><span>ohci0: &lt;OHCI (generic) USB controller&gt; mem 0xfefb9000-0xfefb9fff irq 11 at device 10.0 on pci0
</span><span>usbus0 on ohci0
</span><span>ehci0: &lt;EHCI (generic) USB 2.0 controller&gt; mem 0xfefbb800-0xfefbb8ff irq 11 at device 10.1 on pci0
</span><span>usbus1: EHCI version 1.0
</span><span>usbus1 on ehci0
</span><span>ohci1: &lt;OHCI (generic) USB controller&gt; mem 0xfefba000-0xfefbafff irq 11 at device 11.0 on pci0
</span><span>usbus2 on ohci1
</span><span>ehci1: &lt;EHCI (generic) USB 2.0 controller&gt; mem 0xfefbbc00-0xfefbbcff irq 11 at device 11.1 on pci0
</span><span>usbus3: EHCI version 1.0
</span><span>usbus3 on ehci1
</span><span>atapci0: &lt;Generic ATA controller&gt; port 0x1f0-0x1f7,0x3f6,0x170-0x177,0x376,0xef00-0xef0f irq 14 at device 12.0 on pci0
</span><span>ata0: &lt;ATA channel&gt; at channel 0 on atapci0
</span><span>ata1: &lt;ATA channel&gt; at channel 1 on atapci0
</span><span>cpu0 on motherboard
</span><span>unknown: &lt;PNP0c01&gt; can&#39;t assign resources (memory)
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>attimer0: &lt;AT timer&gt; at port 0x40-0x43 irq 0 pnpid PNP0100 on isa0
</span><span>Timecounter &quot;i8254&quot; frequency 1193182 Hz quality 0
</span><span>Event timer &quot;i8254&quot; frequency 1193182 Hz quality 100
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>atrtc0: &lt;AT realtime clock&gt; at port 0x70-0x71 irq 8 pnpid PNP0b00 on isa0
</span><span>atrtc0: registered as a time-of-day clock, resolution 1.000000s
</span><span>Event timer &quot;RTC&quot; frequency 32768 Hz quality 0
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>atkbdc0: &lt;Keyboard controller (i8042)&gt; at port 0x60,0x64 irq 1 pnpid PNP0303 on isa0
</span><span>atkbd0: &lt;AT Keyboard&gt; irq 1 on atkbdc0
</span><span>kbd0 at atkbd0
</span><span>atkbd0: [GIANT-LOCKED]
</span><span>orm0: &lt;ISA Option ROM&gt; at iomem 0xc0000-0xc7fff pnpid ORM0000 on isa0
</span><span>fdc0: No FDOUT register!
</span><span>ppc0: parallel port not found.
</span><span>unknown: &lt;PNP0c01&gt; can&#39;t assign resources (memory)
</span><span>Firmware Error (ACPI): A valid RSDP was not found (20181213/tbxfroot-369)
</span><span>Timecounters tick every 1.000 msec
</span><span>usbus0: 12Mbps Full Speed USB v1.0
</span><span>usbus1: 480Mbps High Speed USB v2.0
</span><span>ugen0.1: &lt;(0x17f3) OHCI root HUB&gt; at usbus0
</span><span>uhub0: &lt;(0x17f3) OHCI root HUB, class 9/0, rev 1.00/1.00, addr 1&gt; on usbus0
</span><span>ugen1.1: &lt;(0x17f3) EHCI root HUB&gt; at usbus1
</span><span>uhub1: &lt;(0x17f3) EHCI root HUB, class 9/0, rev 2.00/1.00, addr 1&gt; on usbus1
</span><span>usbus2: 12Mbps Full Speed USB v1.0
</span><span>usbus3: 480Mbps High Speed USB v2.0
</span><span>ugen2.1: &lt;(0x17f3) OHCI root HUB&gt; at usbus2
</span><span>uhub2: &lt;(0x17f3) OHCI root HUB, class 9/0, rev 1.00/1.00, addr 1&gt; on usbus2
</span><span>ugen3.1: &lt;(0x17f3) EHCI root HUB&gt; at usbus3
</span><span>uhub3: &lt;(0x17f3) EHCI root HUB, class 9/0, rev 2.00/1.00, addr 1&gt; on usbus3
</span><span>uhub0: 2 ports with 2 removable, self powered
</span><span>uhub2: 2 ports with 2 removable, self powered
</span><span>Trying to mount root from ufs:/dev/da0s1a [rw]...
</span><span>Root mount waiting for: usbus3 usbus1
</span><span>uhub1: 2 ports with 2 removable, self powered
</span><span>uhub3: 2 ports with 2 removable, self powered
</span><span>Root mount waiting for: usbus3 usbus1
</span><span>ugen0.2: &lt;vendor 0x0d8c C-Media USB Audio Device&gt; at usbus0
</span><span>ugen2.2: &lt;Lenovo ThinkPad Compact USB Keyboard with TrackPoint&gt; at usbus2
</span><span>ukbd0 on uhub2
</span><span>ukbd0: &lt;Lenovo ThinkPad Compact USB Keyboard with TrackPoint, class 0/0, rev 2.00/3.30, addr 2&gt; on usbus2
</span><span>kbd2 at ukbd0
</span><span>Root mount waiting for: usbus3
</span><span>Root mount waiting for: usbus3
</span><span>ugen3.2: &lt;Generic USB Storage&gt; at usbus3
</span><span>umass0 on uhub3
</span><span>umass0: &lt;Generic USB Storage, class 0/0, rev 2.00/2.20, addr 2&gt; on usbus3
</span><span>umass0:  SCSI over Bulk-Only; quirks = 0xc100
</span><span>umass0:2:0: Attached to scbus2
</span><span>mountroot: waiting for device /dev/da0s1a...
</span><span>da0 at umass-sim0 bus 0 scbus2 target 0 lun 0
</span><span>da0: &lt;Generic STORAGE DEVICE 0220&gt; Removable Direct Access SCSI device
</span><span>da0: 40.000MB/s transfers
</span><span>da0: 61120MB (125173760 512 byte sectors)
</span><span>da0: quirks=0x3&lt;NO_SYNC_CACHE,NO_6_BYTE&gt;
</span><span>lo0: link state changed to UP
</span><span>vte0: link state changed to DOWN
</span><span>uaudio0 on uhub0
</span><span>uaudio0: &lt;vendor 0x0d8c C-Media USB Audio Device, class 0/0, rev 1.10/1.00, addr 2&gt; on usbus0
</span><span>uaudio0: Play: 48000 Hz, 2 ch, 16-bit S-LE PCM format, 2x8ms buffer.
</span><span>uaudio0: Play: 44100 Hz, 2 ch, 16-bit S-LE PCM format, 2x8ms buffer.
</span><span>uaudio0: Record: 48000 Hz, 1 ch, 16-bit S-LE PCM format, 2x8ms buffer.
</span><span>uaudio0: Record: 44100 Hz, 1 ch, 16-bit S-LE PCM format, 2x8ms buffer.
</span><span>uaudio0: No MIDI sequencer.
</span><span>pcm0: &lt;USB audio&gt; on uaudio0
</span><span>uaudio0: HID volume keys found.
</span><span>ums0 on uhub2
</span><span>ums0: &lt;Lenovo ThinkPad Compact USB Keyboard with TrackPoint, class 0/0, rev 2.00/3.30, addr 2&gt; on usbus2
</span><span>ums0: 6 buttons and [XYZT] coordinates ID=1
</span></code></pre>
